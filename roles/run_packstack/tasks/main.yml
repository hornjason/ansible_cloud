---
- name: Loading Infrastructure File
  include_vars: "{{ playbook_dir }}/roles/generate_vars/vars/main.yml"
  tags: run_packstack
  
- name: Removing Http Proxy from bashrc to avoid "Bad Gateway" issue during Packstack
  lineinfile:
    dest=/root/.bashrc
    regexp="^export http_proxy.*$"
    state=absent
  tags: run_packstack
    
#- name: Removing Https Proxy from bashrc to avoid "Bad Gateway" issue during Packstack
#  lineinfile:
#    dest=/root/.bashrc
#    regexp="^export https_proxy.*$"
#    state=absent
#  tags: run_packstack

# Installing nmap to track latest installed packages
- name: Installing nmap
  yum: name=nmap state=installed

# DEPRECATED # for local repos only
- name: Removing conflicting mariadb-server-galera
  yum: name={{ item }} state=absent
  with_items:
    - mariadb-server-galera

- name: Removing conflicting liberty packages
  yum: name={{ item }} state=absent
  when: openstack_release == 'liberty'
  with_items:
    - mysql-community-libs
    - mysql-community-common


- name: Running Packstack
  shell: /usr/bin/packstack --answer-file="{{ packstack_answer_file }}" > "{{ packstack_output_file }}" 2>&1
  ignore_errors: yes
  register: packstack_run
  tags: run_packstack
    
#  - name: Cleaning up Yum if it failed
#    shell: /usr/bin/yum clean all
#    when: packstack_run|failed
#    tags: run_packstack

#  - name: Cleaning up Yum if it failed
#    shell: /usr/bin/yum clean metadata
#    when: packstack_run|failed
#    tags: run_packstack
#
#    
# DEPRECATED # for local repos only
- name: Removing conflicting mariadb-server-galera
  yum: name=mariadb-server-galera state=absent

- name: restart network before second packstack attempt
  service: name=network state=restarted
  
- name: Running Packstack a second if it failed
  shell: /usr/bin/packstack --answer-file="{{ packstack_answer_file }}" > "{{ packstack_output_file }}" 2>&1
  ignore_errors: no
  when: packstack_run|failed
  tags: run_packstack
